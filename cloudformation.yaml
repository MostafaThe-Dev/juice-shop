AWSTemplateFormatVersion: "2010-09-09"
Description: "OWASP Juice Shop Secure Deployment"

Parameters:
  InstanceType:
    Type: String
    Default: t3.micro
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: SSH Key pair for EC2 instance

Resources:
  JuiceShopSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Juice Shop HTTPS-only access
      VpcId: vpc-0999944f1b9f4560b  # Your default VPC ID
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0

  GuardDutyDetector:
    Type: "AWS::GuardDuty::Detector"
    Properties:
      Enable: true        

  MySecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Allow SSH and HTTP/S from my IP only"
      VpcId: vpc-0999944f1b9f4560b  # Your default VPC ID
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 178.135.22.201/32  # Your public IP
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 178.135.22.201/32
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 178.135.22.201/32

  JuiceShopInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      Path: "/"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
      RoleName: JuiceShopInstanceRole

  JuiceShopInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref JuiceShopInstanceRole

  JuiceShopInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      KeyName: !Ref KeyName
      ImageId: ami-0c02fb55956c7d316  # Amazon Linux 2 in us-east-1
      SecurityGroupIds:
        - !Ref JuiceShopSecurityGroup
        - !Ref MySecurityGroup
      IamInstanceProfile: !Ref JuiceShopInstanceProfile
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: 20
            VolumeType: gp2
            Encrypted: true
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y
          amazon-linux-extras install docker -y
          service docker start
          usermod -a -G docker ec2-user
          docker run -d -p 443:3000 \
            -e HTTPS=true \
            -e SSLKEY=ssl/server.key \
            -e SSLCERT=ssl/server.cert \
            bkimminich/juice-shop

Outputs:
  InstancePublicIP:
    Value: !GetAtt JuiceShopInstance.PublicIp
    Description: Public IP of the Juice Shop EC2 instance
  JuiceShopInstancePublicIP:
    Description: "Public IP of the Juice Shop EC2 instance"
    Value: !GetAtt JuiceShopInstance.PublicIp

